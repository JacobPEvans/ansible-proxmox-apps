#!/bin/bash
# Splunk HEC Forwarder Script with Index Routing
# Generated by Ansible - do not edit manually

HEC_URL="{{ 'https' if cribl_stream_splunk_hec_tls else 'http' }}://{{ cribl_stream_splunk_host }}:{{ cribl_stream_splunk_hec_port }}/services/collector/event"
HEC_TOKEN="{{ cribl_stream_splunk_hec_token }}"
DEFAULT_INDEX="{{ cribl_stream_default_index }}"
DEFAULT_SOURCETYPE="{{ cribl_stream_default_sourcetype }}"

get_routing() {
    local hostname="$1"
    local index="$DEFAULT_INDEX"
    local sourcetype="$DEFAULT_SOURCETYPE"

{% for route in cribl_stream_index_routing %}
    if [[ "$hostname" == *"{{ route.hostname_pattern }}"* ]]; then
        index="{{ route.index }}"
        sourcetype="{{ route.sourcetype }}"
    fi
{% endfor %}

    echo "$index|$sourcetype"
}

while IFS= read -r line; do
    [ -z "$line" ] && continue

    # Extract hostname from syslog message
    # Format is typically: timestamp hostname program: message
    hostname=$(echo "$line" | awk '{print $4}')

    # If hostname is empty or looks like a timestamp, try different position
    if [[ -z "$hostname" ]] || [[ "$hostname" =~ ^[0-9] ]]; then
        hostname=$(echo "$line" | awk '{print $3}')
    fi

    routing=$(get_routing "$hostname")
    index=$(echo "$routing" | cut -d'|' -f1)
    sourcetype=$(echo "$routing" | cut -d'|' -f2)

    escaped=$(echo "$line" | sed 's/\\/\\\\/g; s/"/\\"/g')

    curl -sk "$HEC_URL" \
        -H "Authorization: Splunk $HEC_TOKEN" \
        -d "{\"event\": \"$escaped\", \"sourcetype\": \"$sourcetype\", \"index\": \"$index\", \"host\": \"$hostname\"}" \
        &>/dev/null &
done
