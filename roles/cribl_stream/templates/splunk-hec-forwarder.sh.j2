#!/bin/bash
# Splunk HEC Forwarder Script with Index Routing
# Generated by Ansible - do not edit manually

HEC_URL="{{ 'https' if cribl_stream_splunk_hec_tls else 'http' }}://{{ cribl_stream_splunk_host }}:{{ cribl_stream_splunk_hec_port }}/services/collector/event"
HEC_TOKEN="{{ cribl_stream_splunk_hec_token }}"
DEFAULT_INDEX="{{ cribl_stream_default_index }}"
DEFAULT_SOURCETYPE="{{ cribl_stream_default_sourcetype }}"

get_routing() {
    local hostname="$1"
    local index="$DEFAULT_INDEX"
    local sourcetype="$DEFAULT_SOURCETYPE"

{% for route in cribl_stream_index_routing %}
    if [[ "$hostname" == *"{{ route.hostname_pattern }}"* ]]; then
        index="{{ route.index }}"
        sourcetype="{{ route.sourcetype }}"
    fi
{% endfor %}

    echo "$index|$sourcetype"
}

while IFS= read -r line; do
    [ -z "$line" ] && continue

    # Extract hostname from line provided by rsyslog template
    # Format: HOSTNAME msg_content
    # The HOSTNAME field is reliably extracted by rsyslog regardless of syslog format
    hostname=$(echo "$line" | awk '{print $1; exit}')

    # Extract the message content (everything after hostname and space)
    msg_content=$(echo "$line" | cut -d' ' -f2-)

    routing=$(get_routing "$hostname")
    index=$(echo "$routing" | cut -d'|' -f1)
    sourcetype=$(echo "$routing" | cut -d'|' -f2)

    # Use jq for safe JSON escaping to handle all special characters (newlines, tabs, etc.)
    # Send the full message content as the event (minus redundant hostname prefix)
    payload=$(jq -c -n \
        --arg event "$msg_content" \
        --arg sourcetype "$sourcetype" \
        --arg index "$index" \
        --arg host "$hostname" \
        '{event: $event, sourcetype: $sourcetype, index: $index, host: $host}')

    # Run curl in foreground and check exit code
    # If curl fails (network error, HEC down, etc.), exit with error so rsyslog can retry
    if ! curl -skf "$HEC_URL" \
        -H "Authorization: Splunk $HEC_TOKEN" \
        -d "$payload" \
        -o /dev/null; then
        echo "ERROR: Failed to forward log event to HEC ($(date))" >&2
        exit 1
    fi
done
