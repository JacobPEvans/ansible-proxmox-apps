---
- name: Install Cribl Stream package
  ansible.builtin.apt:
    name: "{{ cribl_stream_package_name }}"
    state: present
    update_cache: true
  register: cribl_stream_install_result
  changed_when: "'0 upgraded' not in cribl_stream_install_result.stdout"

- name: Ensure persistent queue directory exists
  ansible.builtin.file:
    path: "{{ cribl_stream_queue_dir }}"
    owner: "{{ cribl_stream_user }}"
    group: "{{ cribl_stream_group }}"
    mode: '0755'
    state: directory

- name: Configure persistent queue location
  ansible.builtin.lineinfile:
    path: /etc/cribl-stream/default/outputs.yml
    regexp: "^\\s*queueDir:"
    line: "  queueDir: {{ cribl_stream_queue_dir }}"
    backup: true
    create: true
    mode: '0644'
  notify: Restart cribl stream

- name: Configure Stream mode
  ansible.builtin.lineinfile:
    path: /etc/cribl-stream/default/system.yml
    regexp: "^\\s*mode:"
    line: "  mode: {{ cribl_stream_mode }}"
    backup: true
    create: true
    mode: '0644'
  notify: Restart cribl stream

- name: Start Cribl Stream service
  ansible.builtin.systemd:
    name: "{{ cribl_stream_service_name }}"
    state: "{{ cribl_stream_service_state }}"
    enabled: "{{ cribl_stream_service_enabled }}"
    daemon_reload: true

- name: Verify Cribl Stream is running
  ansible.builtin.systemd:
    name: "{{ cribl_stream_service_name }}"
  register: cribl_stream_status
  changed_when: false
  failed_when: cribl_stream_status.status.ActiveState != 'active'
