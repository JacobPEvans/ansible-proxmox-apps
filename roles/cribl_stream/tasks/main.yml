---
# Stream collector role - receives syslog and forwards to Splunk HEC
# Uses rsyslog with custom HEC forwarder script for index routing

- name: Install required packages
  ansible.builtin.apt:
    name:
      - rsyslog
      - curl
    state: present
    update_cache: true

- name: Ensure persistent queue directory exists
  ansible.builtin.file:
    path: "{{ cribl_stream_queue_dir }}"
    owner: "{{ cribl_stream_user }}"
    group: "{{ cribl_stream_group }}"
    mode: '0755'
    state: directory

- name: Deploy Splunk HEC forwarder script
  ansible.builtin.template:
    src: splunk-hec-forwarder.sh.j2
    dest: /usr/local/bin/splunk-hec-forwarder.sh
    owner: root
    group: root
    mode: '0755'
  no_log: true
  notify: Restart rsyslog

- name: Deploy rsyslog syslog-to-HEC configuration
  ansible.builtin.template:
    src: rsyslog-syslog-hec.conf.j2
    dest: /etc/rsyslog.d/60-syslog-hec.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart rsyslog

- name: Start rsyslog service
  ansible.builtin.systemd:
    name: rsyslog
    state: started
    enabled: true
    daemon_reload: true

- name: Verify rsyslog is running
  ansible.builtin.systemd:
    name: rsyslog
  register: cribl_stream_rsyslog_status
  changed_when: false
  failed_when: cribl_stream_rsyslog_status.status.ActiveState != 'active'

- name: Verify syslog port is listening
  ansible.builtin.wait_for:
    port: "{{ cribl_stream_syslog_port }}"
    host: 0.0.0.0
    timeout: 10
  changed_when: false
