---
# Cribl Docker Stack Deployment Tasks
# Deploys Cribl Edge and Stream on Docker Swarm

# =============================================================================
# Docker Installation
# =============================================================================

- name: Gather OS facts
  ansible.builtin.setup:
    filter: ansible_distribution*

- name: Install Docker prerequisites
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: true

- name: Create keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Set Docker repository distribution
  ansible.builtin.set_fact:
    cribl_docker_stack_docker_distro: "{{ ansible_distribution | lower }}"

- name: Add Docker GPG key
  ansible.builtin.get_url:
    url: "https://download.docker.com/linux/{{ cribl_docker_stack_docker_distro }}/gpg"
    dest: /etc/apt/keyrings/docker.asc
    mode: "0644"
    force: false

- name: Add Docker repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc]
      https://download.docker.com/linux/{{ cribl_docker_stack_docker_distro }}
      {{ ansible_distribution_release }} stable
    state: present
    filename: docker

- name: Install Docker packages
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: true

- name: Ensure Docker service is running
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: true

# =============================================================================
# Docker Swarm Configuration
# =============================================================================

- name: Check if Docker Swarm is initialized
  ansible.builtin.command: docker info --format '{{ '{{' }} .Swarm.LocalNodeState {{ '}}' }}'
  register: cribl_docker_stack_swarm_state
  changed_when: false

- name: Initialize Docker Swarm
  community.docker.docker_swarm:
    state: present
    advertise_addr: "{{ cribl_docker_stack_swarm_advertise_addr }}"
  when: cribl_docker_stack_swarm_state.stdout != "active"
  register: cribl_docker_stack_swarm_init

- name: Create Cribl stack configuration directory
  ansible.builtin.file:
    path: /opt/cribl/stack
    state: directory
    owner: root
    group: root
    mode: "0755"

# =============================================================================
# Cribl Edge Configuration - mounted into containers
# =============================================================================

- name: Create Cribl config directory for bind mounts
  ansible.builtin.file:
    path: "{{ cribl_docker_stack_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Create Cribl pipelines directory
  ansible.builtin.file:
    path: "{{ cribl_docker_stack_config_dir }}/pipelines/syslog"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy Cribl inputs configuration
  ansible.builtin.template:
    src: cribl/inputs.yml.j2
    dest: "{{ cribl_docker_stack_config_dir }}/inputs.yml"
    owner: root
    group: root
    mode: "0644"
  register: cribl_docker_stack_inputs_config

- name: Deploy Cribl outputs configuration
  ansible.builtin.template:
    src: cribl/outputs.yml.j2
    dest: "{{ cribl_docker_stack_config_dir }}/outputs.yml"
    owner: root
    group: root
    mode: "0644"
  no_log: true  # Contains HEC token
  register: cribl_docker_stack_outputs_config

- name: Deploy Cribl routes configuration
  ansible.builtin.template:
    src: cribl/routes.yml.j2
    dest: "{{ cribl_docker_stack_config_dir }}/routes.yml"
    owner: root
    group: root
    mode: "0644"
  register: cribl_docker_stack_routes_config

- name: Deploy Cribl syslog pipeline configuration
  ansible.builtin.template:
    src: cribl/pipelines/syslog/conf.yml.j2
    dest: "{{ cribl_docker_stack_config_dir }}/pipelines/syslog/conf.yml"
    owner: root
    group: root
    mode: "0644"
  register: cribl_docker_stack_pipeline_config

# =============================================================================
# Docker Stack Deployment
# =============================================================================

- name: Deploy Cribl Docker stack template
  ansible.builtin.template:
    src: docker-stack.yml.j2
    dest: /opt/cribl/stack/docker-stack.yml
    owner: root
    group: root
    mode: "0644"
  register: cribl_docker_stack_template

- name: Install Python venv and pip for dependencies
  ansible.builtin.apt:
    name:
      - python3-pip
      - python3-venv
      - python3-full
    state: present
    update_cache: true

- name: Create virtualenv for Ansible Python dependencies
  ansible.builtin.pip:
    name:
      - jsondiff
      - docker
    state: present
    virtualenv: /opt/ansible-venv
    virtualenv_command: python3 -m venv

- name: Set Python interpreter to use venv for subsequent tasks
  ansible.builtin.set_fact:
    ansible_python_interpreter: /opt/ansible-venv/bin/python

- name: Deploy Cribl stack to Docker Swarm
  community.docker.docker_stack:
    name: "{{ cribl_docker_stack_name }}"
    state: present
    compose:
      - /opt/cribl/stack/docker-stack.yml
  # Always run - module is idempotent and compares compose to running services
  register: cribl_docker_stack_deploy

- name: Wait for Cribl Edge services to be ready
  ansible.builtin.command: >
    docker service ls --filter name={{ cribl_docker_stack_name }}_cribl-edge
    --format '{{ '{{' }} .Replicas {{ '}}' }}'
  register: cribl_docker_stack_edge_replicas_status
  until: >-
    cribl_docker_stack_edge_replicas_status.stdout ==
    "{{ cribl_docker_stack_edge_replicas }}/{{ cribl_docker_stack_edge_replicas }}"
  retries: 45
  delay: 15
  changed_when: false

- name: Wait for Cribl Stream services to be ready
  ansible.builtin.command: >
    docker service ls --filter name={{ cribl_docker_stack_name }}_cribl-stream
    --format '{{ '{{' }} .Replicas {{ '}}' }}'
  register: cribl_docker_stack_stream_replicas_status
  until: >-
    cribl_docker_stack_stream_replicas_status.stdout ==
    "{{ cribl_docker_stack_stream_replicas }}/{{ cribl_docker_stack_stream_replicas }}"
  retries: 45
  delay: 15
  changed_when: false

- name: Verify Cribl Edge health
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ cribl_docker_stack_edge_web_port }}/api/v1/health"
    method: GET
    return_content: true
    status_code: 200
  register: cribl_docker_stack_edge_health
  retries: 20
  delay: 15
  until: cribl_docker_stack_edge_health.status == 200
  changed_when: false

- name: Verify Cribl Stream health
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ cribl_docker_stack_stream_web_port }}/api/v1/health"
    method: GET
    return_content: true
    status_code: 200
  register: cribl_docker_stack_stream_health
  retries: 20
  delay: 15
  until: cribl_docker_stack_stream_health.status == 200
  changed_when: false

- name: Display Cribl stack status
  ansible.builtin.command: docker stack services {{ cribl_docker_stack_name }}
  register: cribl_docker_stack_status
  changed_when: false

- name: Show Cribl services
  ansible.builtin.debug:
    msg: "{{ cribl_docker_stack_status.stdout_lines }}"

# =============================================================================
# E2E Validation - No manual intervention required
# =============================================================================

- name: Get Cribl Edge container IDs
  ansible.builtin.shell: >
    docker ps -q --filter name={{ cribl_docker_stack_name }}_cribl-edge
  register: cribl_docker_stack_edge_container_ids
  changed_when: false
  failed_when: cribl_docker_stack_edge_container_ids.stdout == ""

- name: Validate Edge containers are not OOM killed
  ansible.builtin.shell: |
    for container_id in {{ cribl_docker_stack_edge_container_ids.stdout_lines | join(' ') }}; do
      exit_code=$(docker inspect --format='{{ '{{' }} .State.ExitCode {{ '}}' }}' "$container_id")
      if [ "$exit_code" = "137" ]; then
        echo "ERROR: Container $container_id was OOM killed (exit code 137)"
        exit 1
      fi
    done
    echo "All Edge containers healthy (no OOM)"
  register: cribl_docker_stack_edge_oom_check
  changed_when: false

- name: Get Cribl Stream container IDs
  ansible.builtin.shell: >
    docker ps -q --filter name={{ cribl_docker_stack_name }}_cribl-stream
  register: cribl_docker_stack_stream_container_ids
  changed_when: false
  failed_when: cribl_docker_stack_stream_container_ids.stdout == ""

- name: Validate Stream containers are not OOM killed
  ansible.builtin.shell: |
    for container_id in {{ cribl_docker_stack_stream_container_ids.stdout_lines | join(' ') }}; do
      exit_code=$(docker inspect --format='{{ '{{' }} .State.ExitCode {{ '}}' }}' "$container_id")
      if [ "$exit_code" = "137" ]; then
        echo "ERROR: Container $container_id was OOM killed (exit code 137)"
        exit 1
      fi
    done
    echo "All Stream containers healthy (no OOM)"
  register: cribl_docker_stack_stream_oom_check
  changed_when: false

- name: E2E Summary
  ansible.builtin.debug:
    msg: |
      === Cribl Docker Stack E2E Validation PASSED ===
      Edge: {{ cribl_docker_stack_edge_replicas }}/{{ cribl_docker_stack_edge_replicas }} healthy
      Stream: {{ cribl_docker_stack_stream_replicas }}/{{ cribl_docker_stack_stream_replicas }} healthy
      Edge OOM Check: {{ cribl_docker_stack_edge_oom_check.stdout }}
      Stream OOM Check: {{ cribl_docker_stack_stream_oom_check.stdout }}
