---
# Syslog processing pipeline
# Generated by Ansible - cribl_docker_stack role
# Processes syslog and routes to Splunk with proper fields

output: splunk_hec
streamtags: []
groups: {}
asyncFuncTimeout: 1000
functions:
  # Set default fields for Splunk based on source port
  - id: eval
    filter: "true"
    disabled: false
    conf:
      add:
        - name: index
          value: >-
            __inputId.includes('1514') ? 'unifi' :
            __inputId.includes('1515') ? 'firewall' :
            __inputId.includes('1516') ? 'firewall' :
            __inputId.includes('1517') ? 'os' :
            __inputId.includes('1518') ? 'os' :
            __inputId.includes('netflow') ? 'network' :
            'main'
        - name: sourcetype
          value: >-
            __inputId.includes('1514') ? 'ubiquiti:unifi' :
            __inputId.includes('1515') ? 'pan:firewall' :
            __inputId.includes('1516') ? 'cisco:asa' :
            __inputId.includes('1517') ? 'syslog' :
            __inputId.includes('1518') ? 'syslog' :
            __inputId.includes('netflow') ? 'netflow' :
            'syslog'
        - name: source
          value: >-
            __inputId.includes('netflow') ? 'netflow:2055' :
            'syslog:' + __inputId.match(/\d{4}/)?.[0]

  # Extract host from syslog message if available
  - id: regex_extract
    filter: "!__inputId.includes('netflow')"
    disabled: false
    conf:
      source: _raw
      iterations: 100
      overwrite: false
      regex: /^<\d+>(?:\d+ )?(?:(?<timestamp>\w{3}\s+\d+\s+[\d:]+)|(?<timestamp_iso>\d{4}-\d{2}-\d{2}T[\d:.Z+-]+))\s+(?<log_host>\S+)\s+(?<process>[^\[:\s]+)(?:\[(?<pid>\d+)\])?[:\s]+(?<message>.*)/

  # Use extracted host if available
  - id: eval
    filter: log_host != null
    disabled: false
    conf:
      add:
        - name: host
          value: log_host

  # Clean up intermediate fields
  - id: eval
    filter: "true"
    disabled: false
    conf:
      remove:
        - log_host
        - timestamp_iso
