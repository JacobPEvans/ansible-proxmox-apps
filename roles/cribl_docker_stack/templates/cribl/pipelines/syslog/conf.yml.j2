---
# Syslog processing pipeline
# Generated by Ansible - cribl_docker_stack role
# Processes syslog and routes to Splunk with proper fields

output: splunk_hec
streamtags: []
groups: {}
asyncFuncTimeout: 1000
functions:
  # Set default fields for Splunk based on source port
  - id: eval
    filter: "true"
    disabled: false
    conf:
      add:
        - name: index
          value: >-
            (() => {
              switch(true) {
                case __inputId.includes('1514'): return 'unifi';
                case __inputId.includes('1515'):
                case __inputId.includes('1516'): return 'firewall';
                case __inputId.includes('1517'):
                case __inputId.includes('1518'): return 'os';
                case __inputId.includes('netflow'): return 'network';
                default: return 'main';
              }
            })()
        - name: sourcetype
          value: >-
            (() => {
              switch(true) {
                case __inputId.includes('1514'): return 'ubiquiti:unifi';
                case __inputId.includes('1515'): return 'pan:firewall';
                case __inputId.includes('1516'): return 'cisco:asa';
                case __inputId.includes('1517'):
                case __inputId.includes('1518'): return 'syslog';
                case __inputId.includes('netflow'): return 'netflow';
                default: return 'syslog';
              }
            })()
        - name: source
          value: >-
            __inputId.includes('netflow') ? 'netflow:2055' :
            'syslog:' + (__inputId.match(/\d{4}/)?.[0] ?? '0000')

  # Extract host from syslog message if available
  - id: regex_extract
    filter: "!__inputId.includes('netflow')"
    disabled: false
    conf:
      source: _raw
      iterations: 100
      overwrite: false
      regex: /^<\d+>(?:\d+ )?(?:(?<timestamp>\w{3}\s+\d+\s+[\d:]+)|(?<timestamp_iso>\d{4}-\d{2}-\d{2}T[\d:.Z+-]+))\s+(?<log_host>\S+)\s+(?<process>[^\[:\s]+)(?:\[(?<pid>\d+)\])?[:\s]+(?<message>.*)/

  # Use extracted host if available
  - id: eval
    filter: log_host != null
    disabled: false
    conf:
      add:
        - name: host
          value: log_host

  # Clean up intermediate fields
  - id: eval
    filter: "true"
    disabled: false
    conf:
      remove:
        - log_host
        - timestamp_iso
