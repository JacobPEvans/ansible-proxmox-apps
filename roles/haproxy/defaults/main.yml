---
# HAProxy + Nginx Stream Load Balancer role defaults

# Package management
haproxy_package_name: haproxy
haproxy_nginx_package_name: nginx

# Service configuration
haproxy_service_name: haproxy
haproxy_service_state: started
haproxy_service_enabled: true

haproxy_nginx_service_name: nginx
haproxy_nginx_service_state: started
haproxy_nginx_service_enabled: true

# Syslog port mappings: frontend (HAProxy/Nginx) -> backend (Cribl Edge)
# Standard ports (514-518) map to high ports (1514-1518) on backends
# This allows clients to use standard syslog ports while keeping backends on non-privileged ports
haproxy_syslog_port_mappings:
  - frontend: 514
    backend: 1514
    name: unifi
  - frontend: 515
    backend: 1515
    name: palo_alto
  - frontend: 516
    backend: 1516
    name: cisco_asa
  - frontend: 517
    backend: 1517
    name: linux
  - frontend: 518
    backend: 1518
    name: windows
  # Also keep high ports for backwards compatibility
  - frontend: 1514
    backend: 1514
    name: unifi_high
  - frontend: 1515
    backend: 1515
    name: palo_alto_high
  - frontend: 1516
    backend: 1516
    name: cisco_asa_high
  - frontend: 1517
    backend: 1517
    name: linux_high
  - frontend: 1518
    backend: 1518
    name: windows_high

# NetFlow port (unchanged - no standard port equivalent)
haproxy_netflow_port:
  frontend: 2055
  backend: 2055

# Backend servers - Cribl Edge nodes
# IP addresses derived from inventory (NEVER hardcoded)
haproxy_backend_servers:
  - name: cribl-edge-01
    ip: "{{ hostvars['cribl_edge_01'].ansible_host }}"
  - name: cribl-edge-02
    ip: "{{ hostvars['cribl_edge_02'].ansible_host }}"

# Legacy variables for backwards compatibility (derived from mappings)
haproxy_listen_ports: >-
  {{ haproxy_syslog_port_mappings | map(attribute='frontend') | list
     + [haproxy_netflow_port.frontend] }}
haproxy_nginx_udp_ports: >-
  {{ haproxy_syslog_port_mappings | map(attribute='frontend') | list
     + [haproxy_netflow_port.frontend] }}
haproxy_backends: "{{ haproxy_backend_servers }}"

# Health check configuration
haproxy_health_check_interval: 5000
haproxy_health_check_timeout: 5000

# Statistics dashboard
haproxy_stats_enabled: true
haproxy_stats_port: 8404
haproxy_stats_user: admin
# NOTE: Use a strong password from Doppler secrets in production
# This default is intentionally weak - override with vault lookup
haproxy_stats_password: "{{ lookup('env', 'HAPROXY_STATS_PASSWORD') | default('CHANGEME') }}"

# Load balancing algorithm (used by both HAProxy and Nginx)
haproxy_algorithm: roundrobin

# Configuration files
haproxy_config_file: /etc/haproxy/haproxy.cfg
haproxy_nginx_config_file: /etc/nginx/nginx.conf
haproxy_nginx_stream_config_file: /etc/nginx/streams.d/syslog-lb.conf
