# Rsyslog UDP to TCP forwarding for HAProxy syslog load balancing
# HAProxy only supports TCP, so rsyslog receives UDP and forwards via TCP

# Load UDP input module
module(load="imudp")

# Listen on UDP ports for syslog
{% for port in haproxy_udp_ports %}
input(type="imudp" port="{{ port }}" ruleset="forward_to_cribl")
{% endfor %}

# Forward all received UDP syslog to Cribl Edge via TCP
# Uses failover: if primary fails, switches to secondary
ruleset(name="forward_to_cribl") {
{% for backend in haproxy_backends %}
{% if loop.first %}
    action(
        type="omfwd"
        target="{{ backend.ip }}"
        port="{{ backend.port }}"
        protocol="tcp"
        action.resumeRetryCount="-1"
        action.resumeInterval="10"
        queue.type="LinkedList"
        queue.filename="cribl_{{ backend.name | replace('-', '_') }}"
        queue.saveonshutdown="on"
    )
{% else %}
    action(
        type="omfwd"
        target="{{ backend.ip }}"
        port="{{ backend.port }}"
        protocol="tcp"
        action.resumeRetryCount="-1"
        action.resumeInterval="10"
        action.execOnlyWhenPreviousIsSuspended="on"
        queue.type="LinkedList"
        queue.filename="cribl_{{ backend.name | replace('-', '_') }}"
        queue.saveonshutdown="on"
    )
{% endif %}
{% endfor %}
}
