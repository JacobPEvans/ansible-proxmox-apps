global
  log stdout local0
  log stdout local1 notice
  chroot /var/lib/haproxy
  stats socket /run/haproxy/admin.sock mode 660 level admin
  stats timeout 30s
  user haproxy
  group haproxy
  daemon

  # Default SSL material locations
  ca-base /etc/ssl/certs
  crt-base /etc/ssl/private

defaults
  log global
  mode tcp
  option tcplog
  timeout connect 5000
  timeout client 60000
  timeout server 60000

{% if haproxy_stats_enabled %}
# Statistics dashboard
listen stats
  bind *:{{ haproxy_stats_port }}
  mode http
  stats enable
  stats uri /stats
  stats refresh 10s
  stats admin if TRUE
  stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
{% endif %}

# Syslog TCP load balancing frontends
# Note: UDP is handled by rsyslog, not HAProxy
{% for port in haproxy_listen_ports %}
frontend syslog_{{ port }}
  bind *:{{ port }}
  mode tcp
  default_backend syslog_backend

{% endfor %}

# TCP backend for syslog servers (Cribl Edge nodes)
backend syslog_backend
  mode tcp
  balance {{ haproxy_algorithm }}
  option tcp-check
{% for backend in haproxy_backends %}
  server {{ backend.name }} {{ backend.ip }}:{{ backend.port }} check inter {{ haproxy_health_check_interval }} timeout {{ haproxy_health_check_timeout }}
{% endfor %}
