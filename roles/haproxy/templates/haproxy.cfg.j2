global
  log stdout local0
  log stdout local1 notice
  chroot /var/lib/haproxy
  stats socket /run/haproxy/admin.sock mode 660 level admin
  stats timeout 30s
  user haproxy
  group haproxy
  daemon

  # Default SSL material locations
  ca-base /etc/ssl/certs
  crt-base /etc/ssl/private

defaults
  log global
  mode tcp
  option tcplog
  timeout connect 5000
  timeout client 60000
  timeout server 60000

{% if haproxy_stats_enabled %}
# Statistics dashboard
listen stats
  bind *:{{ haproxy_stats_port }}
  mode http
  stats enable
  stats uri /stats
  stats refresh 10s
  stats admin if TRUE
  stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
{% endif %}

# =============================================================================
# Syslog TCP Load Balancing
# Frontend port -> Backend port mapping (e.g., 514 -> 1514)
# =============================================================================
{% for mapping in haproxy_syslog_port_mappings %}

# {{ mapping.name | upper }} - Port {{ mapping.frontend }} -> {{ mapping.backend }}
frontend syslog_{{ mapping.name }}_{{ mapping.frontend }}
  bind *:{{ mapping.frontend }}
  mode tcp
  default_backend syslog_backend_{{ mapping.backend }}

{% endfor %}

# NetFlow traffic is handled via Nginx (UDP stream); no TCP NetFlow frontend is defined in HAProxy.

# =============================================================================
# TCP Backends for Cribl Edge nodes (one per destination port)
# =============================================================================
{% set unique_backend_ports = (haproxy_syslog_port_mappings | map(attribute='backend') | list) | unique %}
{% for backend_port in unique_backend_ports %}

backend syslog_backend_{{ backend_port }}
  mode tcp
  balance {{ haproxy_algorithm }}
  option tcp-check
  timeout server {{ haproxy_health_check_timeout }}
{% for server in haproxy_backend_servers %}
  server {{ server.name }} {{ server.ip }}:{{ backend_port }} check inter {{ haproxy_health_check_interval }}
{% endfor %}
{% endfor %}
