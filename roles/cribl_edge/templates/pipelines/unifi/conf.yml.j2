---
# UniFi syslog processing pipeline
# Generated by Ansible

output: splunk_hec
streamtags: []
groups: {}
asyncFuncTimeout: 1000
functions:
  # Set default fields for Splunk
  - id: eval
    filter: "true"
    disabled: false
    conf:
      add:
        - name: index
          value: "'unifi'"
        - name: sourcetype
          value: "'ubiquiti:unifi'"
        - name: source
          value: "'syslog:{{ cribl_edge_syslog_port }}'"

  # Extract host from syslog message if available
  - id: regex_extract
    filter: "true"
    disabled: false
    conf:
      source: _raw
      iterations: 100
      overwrite: false
      regex: /^<\d+>(?:\d+ )?(?:(?<timestamp>\w{3}\s+\d+\s+[\d:]+)|(?<timestamp_iso>\d{4}-\d{2}-\d{2}T[\d:.Z+-]+))\s+(?<log_host>\S+)\s+(?<process>[^\[:\s]+)(?:\[(?<pid>\d+)\])?[:\s]+(?<message>.*)/

  # Use extracted host if available
  - id: eval
    filter: log_host != null
    disabled: false
    conf:
      add:
        - name: host
          value: log_host

  # Clean up intermediate fields
  - id: eval
    filter: "true"
    disabled: false
    conf:
      remove:
        - log_host
        - timestamp_iso
