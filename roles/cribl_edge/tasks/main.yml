---
- name: Ensure /tmp/.ansible-tmp directory exists
  ansible.builtin.raw: mkdir -p /tmp/.ansible-tmp && chmod 1777 /tmp/.ansible-tmp
  changed_when: false

- name: Ensure /var/tmp/.ansible directory exists
  ansible.builtin.raw: mkdir -p /var/tmp/.ansible && chmod 1777 /var/tmp/.ansible
  changed_when: false

- name: Install Cribl Edge package
  ansible.builtin.apt:
    name: "{{ cribl_edge_package_name }}"
    state: present
    update_cache: true
  register: cribl_edge_install_result
  changed_when: "'0 upgraded' not in cribl_edge_install_result.stdout"

- name: Ensure persistent queue directory exists
  ansible.builtin.file:
    path: "{{ cribl_edge_queue_dir }}"
    owner: "{{ cribl_edge_user }}"
    group: "{{ cribl_edge_group }}"
    mode: '0755'
    state: directory

- name: Configure persistent queue location
  ansible.builtin.lineinfile:
    path: /etc/cribl/default/outputs.yml
    regexp: "^\\s*queueDir:"
    line: "  queueDir: {{ cribl_edge_queue_dir }}"
    backup: true
    create: true
    mode: '0644'
  notify: Restart cribl edge

- name: Configure Splunk HEC output
  ansible.builtin.template:
    src: outputs.yml.j2
    dest: /etc/cribl/default/outputs.yml
    owner: "{{ cribl_edge_user }}"
    group: "{{ cribl_edge_group }}"
    mode: '0600'
  no_log: true
  notify: Restart cribl edge
  when: cribl_edge_hec_token != ''

- name: Deploy syslog inputs configuration
  ansible.builtin.template:
    src: inputs.yml.j2
    dest: /etc/cribl/default/inputs.yml
    owner: "{{ cribl_edge_user }}"
    group: "{{ cribl_edge_group }}"
    mode: '0644'
  notify: Restart cribl edge

- name: Start Cribl Edge service
  ansible.builtin.systemd:
    name: "{{ cribl_edge_service_name }}"
    state: "{{ cribl_edge_service_state }}"
    enabled: "{{ cribl_edge_service_enabled }}"
    daemon_reload: true

- name: Verify Cribl Edge is running
  ansible.builtin.systemd:
    name: "{{ cribl_edge_service_name }}"
  register: cribl_edge_status
  changed_when: false
  failed_when: cribl_edge_status.status.ActiveState != 'active'
