---
# Cribl Edge Docker deployment tasks

- name: Install Docker packages
  ansible.builtin.apt:
    name:
      - docker.io
      - docker-compose-plugin
    state: present
    update_cache: true

- name: Ensure Docker service is running
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: true

- name: Create Cribl Edge directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ cribl_edge_user }}"
    group: "{{ cribl_edge_group }}"
    mode: '0755'
  loop:
    - "{{ cribl_edge_data_dir }}"
    - "{{ cribl_edge_config_dir }}"
    - "{{ cribl_edge_queue_dir }}"
    - "{{ cribl_edge_config_dir }}/local"
    - "{{ cribl_edge_config_dir }}/local/cribl"
    - "{{ cribl_edge_config_dir }}/local/cribl/pipelines"
    - "{{ cribl_edge_config_dir }}/local/cribl/pipelines/unifi"

- name: Deploy docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ cribl_edge_config_dir }}/docker-compose.yml"
    owner: "{{ cribl_edge_user }}"
    group: "{{ cribl_edge_group }}"
    mode: '0600'
  notify: restart cribl edge

- name: Deploy Cribl outputs configuration
  ansible.builtin.template:
    src: outputs.yml.j2
    dest: "{{ cribl_edge_config_dir }}/local/cribl/outputs.yml"
    owner: "{{ cribl_edge_user }}"
    group: "{{ cribl_edge_group }}"
    mode: '0600'
  no_log: true
  notify: restart cribl edge
  when: cribl_edge_hec_token != ''

- name: Deploy Cribl inputs configuration
  ansible.builtin.template:
    src: inputs.yml.j2
    dest: "{{ cribl_edge_config_dir }}/local/cribl/inputs.yml"
    owner: "{{ cribl_edge_user }}"
    group: "{{ cribl_edge_group }}"
    mode: '0644'
  notify: restart cribl edge

- name: Deploy UniFi pipeline configuration
  ansible.builtin.template:
    src: pipelines/unifi/conf.yml.j2
    dest: "{{ cribl_edge_config_dir }}/local/cribl/pipelines/unifi/conf.yml"
    owner: "{{ cribl_edge_user }}"
    group: "{{ cribl_edge_group }}"
    mode: '0644'
  notify: restart cribl edge

- name: Pull Cribl Edge Docker image
  community.docker.docker_image:
    name: "{{ cribl_edge_docker_image }}"
    source: pull
    state: present

- name: Start Cribl Edge container with docker-compose
  community.docker.docker_compose_v2:
    project_src: "{{ cribl_edge_config_dir }}"
    state: present
  register: cribl_edge_compose_result

- name: Wait for Cribl Edge to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:9000/api/v1/health"
    status_code: 200
  register: cribl_edge_health
  until: cribl_edge_health.status == 200
  retries: 12
  delay: 5
  ignore_errors: true

- name: Display Cribl Edge status
  ansible.builtin.debug:
    msg: "Cribl Edge is {{ 'running' if cribl_edge_health.status == 200 else 'starting (may need more time)' }}"
