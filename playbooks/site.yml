---
# Import Terraform infrastructure data before running application playbooks
# This populates the inventory dynamically from terraform_inventory.json
# Must run with gather_facts: false to avoid Gathering Facts task
- name: Load Terraform infrastructure inventory
  import_playbook: ../inventory/load_terraform.yml

# Configure application stacks based on Terraform infrastructure

# Full Logging Pipeline: UniFi → HAProxy → Cribl Edge → Splunk
# Run order matters: Splunk first, then Cribl, then HAProxy

- name: Configure Splunk Docker
  hosts: splunk_vms
  become: true
  tags:
    - splunk_docker

  roles:
    - role: splunk_docker

- name: Configure Cribl Edge nodes
  hosts: cribl_edge
  become: true
  gather_facts: false
  tags:
    - cribl_edge

  roles:
    - role: cribl_edge

- name: Configure Cribl Stream
  hosts: cribl_stream_group
  become: true
  gather_facts: false
  tags:
    - cribl_stream

  roles:
    - role: cribl_stream

- name: Configure HAProxy load balancer
  hosts: haproxy_group
  become: true
  gather_facts: false
  tags:
    - haproxy

  roles:
    - role: haproxy
