---
# Import Terraform infrastructure data before running application playbooks
# This populates the inventory dynamically from terraform_inventory.json
- name: Import Terraform infrastructure inventory  # noqa: name[play]
  import_playbook: ../inventory/load_terraform.yml

# Configure application stacks based on Terraform infrastructure

# Full Logging Pipeline: UniFi → HAProxy → Cribl Edge → Splunk
# Run order matters: Splunk first, then Cribl, then HAProxy

- name: Configure Cribl Edge nodes
  hosts: lxc_containers
  become: true
  tags:
    - cribl_edge

  pre_tasks:
    - name: Check if host should run cribl_edge role
      ansible.builtin.set_fact:
        run_cribl_edge: "{{ 'cribl_edge' in (tags | default([])) }}"

  roles:
    - role: cribl_edge
      when: run_cribl_edge | default(false)

- name: Configure Cribl Stream
  hosts: vms
  become: true
  tags:
    - cribl_stream

  pre_tasks:
    - name: Check if host should run cribl_stream role
      ansible.builtin.set_fact:
        run_cribl_stream: "{{ 'cribl_stream' in (tags | default([])) }}"

  roles:
    - role: cribl_stream
      when: run_cribl_stream | default(false)

- name: Configure HAProxy load balancer
  hosts: lxc_containers
  become: true
  tags:
    - haproxy

  pre_tasks:
    - name: Check if host should run haproxy_syslog role
      ansible.builtin.set_fact:
        run_haproxy: "{{ 'haproxy' in (tags | default([])) }}"

  roles:
    - role: haproxy_syslog
      when: run_haproxy | default(false)
