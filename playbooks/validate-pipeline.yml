---
# Logging Pipeline Validation Playbook
# Validates connectivity, service health, and data flow across the pipeline
#
# Usage:
#   doppler run -- uv run ansible-playbook \
#     -i inventory/hosts.yml playbooks/validate-pipeline.yml

- name: Import Terraform infrastructure inventory
  import_playbook: ../inventory/load_terraform.yml

- name: Validate HAProxy Load Balancer
  hosts: lxc_containers
  become: true
  gather_facts: false
  tags:
    - haproxy
    - validation

  vars:
    constants: "{{ hostvars['localhost']['terraform_data']['constants'] }}"

  pre_tasks:
    - name: Check if host is haproxy
      ansible.builtin.set_fact:
        is_haproxy: "{{ 'loadbalancer' in (host_tags | default([])) }}"

  tasks:
    - name: HAProxy validation tasks
      when: is_haproxy | default(false)
      block:
        - name: Verify HAProxy service is running
          ansible.builtin.systemd:
            name: haproxy
            state: started
          check_mode: true
          register: haproxy_status

        - name: Check HAProxy configuration validity
          ansible.builtin.command:
            cmd: haproxy -c -f /etc/haproxy/haproxy.cfg
          register: haproxy_config_check
          changed_when: false
          failed_when: haproxy_config_check.rc != 0

        - name: Verify syslog ports are listening
          ansible.builtin.wait_for:
            port: "{{ item }}"
            timeout: 5
          loop: "{{ constants.syslog_ports.values() | list | sort }}"

        - name: Verify stats page is accessible
          ansible.builtin.wait_for:
            port: "{{ constants.service_ports.haproxy_stats }}"
            timeout: 5

        - name: Get HAProxy backend status via stats socket
          ansible.builtin.command:
            cmd: >-
              socat - UNIX-CONNECT:/run/haproxy/admin.sock
            stdin: "show servers state\n"
          register: haproxy_backend
          changed_when: false
          failed_when: false

        - name: Display HAProxy validation results
          ansible.builtin.debug:
            msg: |
              HAProxy validation passed: config valid, all ports listening
              Backend status:
              {{ haproxy_backend.stdout | default('Socket not available') }}

- name: Validate Cribl Edge Nodes
  hosts: lxc_containers
  become: true
  gather_facts: false
  tags:
    - cribl_edge
    - validation

  vars:
    constants: "{{ hostvars['localhost']['terraform_data']['constants'] }}"

  pre_tasks:
    - name: Check if host is cribl_edge
      ansible.builtin.set_fact:
        is_cribl_edge: >-
          {{ 'edge' in (host_tags | default([])) and
             'cribl' in (host_tags | default([])) }}

  tasks:
    - name: Cribl Edge validation tasks
      when: is_cribl_edge | default(false)
      block:
        - name: Verify Cribl Edge container is running
          community.docker.docker_container_info:
            name: cribl-edge
          register: cribl_edge_container

        - name: Assert Cribl Edge is running
          ansible.builtin.assert:
            that:
              - cribl_edge_container.container is defined
              - cribl_edge_container.container.State.Running
            fail_msg: "Cribl Edge container is not running"
            success_msg: "Cribl Edge container is running"

        - name: Check Cribl Edge syslog ports
          ansible.builtin.wait_for:
            port: "{{ item }}"
            timeout: 5
          loop: "{{ constants.syslog_ports.values() | list | sort }}"

        - name: Display Cribl Edge validation results
          ansible.builtin.debug:
            msg: "Cribl Edge validation passed: container running, all syslog ports listening"

- name: Validate Cribl Docker Swarm Stack
  hosts: cribl_docker_group
  become: true
  gather_facts: true
  tags:
    - cribl_docker_stack
    - swarm
    - validation

  vars:
    constants: "{{ hostvars['localhost']['terraform_data']['constants'] }}"
    cribl_docker_stack_name: cribl
    cribl_docker_stack_edge_replicas: 2
    cribl_docker_stack_stream_replicas: 1

  tasks:
    - name: Check Edge service replicas
      ansible.builtin.command: >
        docker service ls --filter name={{ cribl_docker_stack_name }}_cribl-edge
        --format '{{ '{{' }} .Replicas {{ '}}' }}'
      register: edge_replicas
      changed_when: false
      failed_when: >-
        edge_replicas.stdout !=
        "{{ cribl_docker_stack_edge_replicas }}/{{ cribl_docker_stack_edge_replicas }}"

    - name: Check Stream service replicas
      ansible.builtin.command: >
        docker service ls --filter name={{ cribl_docker_stack_name }}_cribl-stream
        --format '{{ '{{' }} .Replicas {{ '}}' }}'
      register: stream_replicas
      changed_when: false
      failed_when: >-
        stream_replicas.stdout !=
        "{{ cribl_docker_stack_stream_replicas }}/{{ cribl_docker_stack_stream_replicas }}"

    - name: Verify Edge health endpoint
      ansible.builtin.uri:
        url: >-
          http://127.0.0.1:{{ constants.service_ports.cribl_edge_api
          }}/api/v1/health
        method: GET
        return_content: true
        status_code: 200
      register: edge_health

    - name: Verify Stream health endpoint
      ansible.builtin.uri:
        url: >-
          http://127.0.0.1:{{ constants.service_ports.cribl_stream_api
          }}/api/v1/health
        method: GET
        return_content: true
        status_code: 200
      register: stream_health

    - name: Inspect Docker network for container connectivity
      ansible.builtin.command: >-
        docker network inspect {{ cribl_docker_stack_name }}_default
        --format
        '{% raw %}{{range .Containers}}{{.Name}} {{.IPv4Address}}{{"\\n"}}{{end}}{% endraw %}'
      register: docker_network
      changed_when: false
      failed_when: false

    - name: Check Cribl Edge service logs (last 10 lines)
      ansible.builtin.command: >-
        docker service logs {{ cribl_docker_stack_name }}_cribl-edge
        --tail 10 --no-trunc
      register: edge_logs
      changed_when: false
      failed_when: false

    - name: Check Cribl Stream service logs (last 10 lines)
      ansible.builtin.command: >-
        docker service logs {{ cribl_docker_stack_name }}_cribl-stream
        --tail 10 --no-trunc
      register: stream_logs
      changed_when: false
      failed_when: false

    - name: Display Cribl Docker Swarm validation results
      ansible.builtin.debug:
        msg: |
          Cribl Docker Swarm validation passed:
          - Edge: {{ edge_replicas.stdout }} replicas healthy
          - Stream: {{ stream_replicas.stdout }} replicas healthy
          Docker network:
          {{ docker_network.stdout | default('Unable to inspect network') }}
          Recent Edge logs:
          {{ edge_logs.stdout | default('No logs available') }}
          Recent Stream logs:
          {{ stream_logs.stdout | default('No logs available') }}

- name: E2E Data Pipeline Validation
  hosts: cribl_docker_group
  become: true
  gather_facts: true
  tags:
    - e2e
    - data_validation

  vars:
    constants: "{{ hostvars['localhost']['terraform_data']['constants'] }}"
    # Generate unique test event ID using epoch timestamp
    e2e_test_event_id: "E2E_VALIDATION_{{ ansible_date_time.epoch }}"
    # Splunk connection details (no hardcoded fallback)
    splunk_host: "{{ hostvars['splunk']['ansible_host'] }}"
    splunk_port: "{{ constants.service_ports.splunk_mgmt }}"
    splunk_user: admin
    # SPLUNK_PASSWORD must be set via Doppler
    splunk_password: "{{ lookup('env', 'SPLUNK_PASSWORD') }}"

  tasks:
    - name: Verify SPLUNK_PASSWORD is set
      ansible.builtin.assert:
        that:
          - splunk_password | length > 0
        fail_msg: >-
          SPLUNK_PASSWORD environment variable must be set.
          Run with doppler run --
        quiet: true

    - name: Install netcat for syslog testing
      ansible.builtin.apt:
        name: netcat-openbsd
        state: present
        update_cache: true

    - name: Send test syslog message through pipeline
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          echo "<14>{{ ansible_date_time.iso8601 }} ansible-e2e-test: \
          {{ e2e_test_event_id }}" | \
          nc -u -w1 localhost {{ constants.syslog_ports.unifi }}
        executable: /bin/bash
      changed_when: false

    - name: Wait for event to propagate through pipeline
      ansible.builtin.pause:
        seconds: 30
        prompt: >-
          Waiting for test event to propagate through Cribl to Splunk...

    - name: Query Splunk for test event
      ansible.builtin.uri:
        url: >-
          https://{{ splunk_host }}:{{ splunk_port
          }}/services/search/jobs
        method: POST
        user: "{{ splunk_user }}"
        password: "{{ splunk_password }}"
        force_basic_auth: true
        validate_certs: false
        body_format: form-urlencoded
        body:
          search: 'search index=* "{{ e2e_test_event_id }}" | head 1'
          output_mode: json
          exec_mode: oneshot
      register: splunk_search_result
      retries: 6
      delay: 10
      until: >-
        splunk_search_result.status == 200 and
        (splunk_search_result.json.results | default([]) | length > 0)
      failed_when: >-
        splunk_search_result.status != 200 or
        (splunk_search_result.json.results | default([]) | length == 0)

    - name: E2E Data Pipeline PASSED
      ansible.builtin.debug:
        msg: |
          === E2E DATA PIPELINE VALIDATION PASSED ===
          Test event sent via syslog port {{ constants.syslog_ports.unifi }}
          Event ID: {{ e2e_test_event_id }}
          Splunk host: {{ splunk_host }}
          Search results: {{ splunk_search_result.json.results | length }} event(s) found
          Full pipeline verified: Source -> Cribl Edge -> Cribl Stream -> Splunk HEC -> Splunk Index

- name: Pipeline Summary
  hosts: localhost
  gather_facts: false
  tags:
    - summary

  tasks:
    - name: Display pipeline validation summary
      ansible.builtin.debug:
        msg: |
          ============================================
          LOGGING PIPELINE VALIDATION COMPLETE
          ============================================
          Cribl Edge:  Docker Swarm replicas healthy
          Cribl Stream: Docker Swarm replica healthy
          E2E:         Data flowing through pipeline
          ============================================
          Pipeline is ready for log ingestion!
